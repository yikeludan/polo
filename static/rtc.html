<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    .none {
        -webkit-filter: none;
    }

    .blur {
        -webkit-filter: blur(3px);
    }

    .grayscale {
        -webkit-filter: grayscale(1);
    }

    .invert {
        -webkit-filter: invert(1);
    }

    .sepia {
        -webkit-filter: sepia(1);
    }

</style>
<body>
<div>
    <label>Filter:</label>
    <select id="filter">
        <option value="none">None</option>
        <option value="blur">blur</option>
        <option value="grayscale">Grayscale</option>
        <option value="invert">Invert</option>
        <option value="sepia">sepia</option>
    </select>
    <button id="record">Start Record</button>
    <button id="recplay" disabled>Play</button>
    <button id="download" disabled>Download</button>

</div>
<video autoplay playsinline id="player" ></video>
<video  playsinline id="recplayer" ></video>

</body>
</html>

<script src="adapter-latest.js"></script>
<script>
   var filtersSelect = document.querySelector('select#filter');
   filtersSelect.onchange = function(){
       video.className = filtersSelect.value;
   }
   var video = document.getElementById('player');
   var buffer;
   //record
   var recvideo = document.querySelector('video#recplayer');
   var btnRecord = document.querySelector('button#record');
   var btnPlay = document.querySelector('button#recplay');
   var btnDownload = document.querySelector('button#download');
   var mediaRecorder;
   btnRecord.onclick = () =>{
       if(btnRecord.textContent === 'Start Record'){
           startRecord();
           btnRecord.textContent = 'Stop Record';
          // btnPlay.disabled = true;
          // btnDownload.disabled = true;
       }else{

           stopRecord();
           btnRecord.textContent = 'Start Record';
         //  btnPlay.disabled = false;
          // btnDownload.disabled = false;

       }
   }
   btnPlay.onclick =()=>{
       var blob = new Blob(buffer,{type:'video/webm'})
       console.log(blob)

       recvideo.src = window.URL.createObjectURL(blob)
       recvideo.srcObject = null;
       recvideo.controls  = true;
       recvideo.play();
   }
   function startRecord(){
       buffer = [];
       var options = {
           mimeType:'video/webm;codecs=vp8'
       }
       if(!MediaRecorder.isTypeSupported(options.mimeType)){
           console.log("mimeType 不支持")
           return;
       }
       mediaRecorder = new MediaRecorder(window.stream, options);
       mediaRecorder.ondataavailable = handleDataAvailable;
       mediaRecorder.start(10)//时间片

   }
   function handleDataAvailable(e){
       if(e&&e.data&&e.data.size>0){
           buffer.push(e.data)
       }
   }

   function stopRecord(){
       mediaRecorder.stop()
   }


   function start(){
    if(!navigator.mediaDevices ||
        !navigator.mediaDevices.enumerateDevices){
        console.log('enumerateDevices is not supported!');
    }else {

        var pt = {
            video: {
                width:300,
                height:500
            },
            audio: {
                noiseSuppression:true,//降噪
                echoCancellation:true//回音 消除
            }

        }
        navigator.mediaDevices.getUserMedia(pt).then(getMedia).catch(handleError);

    }
   }
    function getMedia(stream) {
       window.stream = stream;
        video.srcObject = stream;
    }

    function gotDevices(deviceInfos){
        deviceInfos.forEach( function(deviceInfo){
            console.log(deviceInfo.kind + ": label = "
                + deviceInfo.label + ": id = "
                + deviceInfo.deviceId + ": groupId = "
                + deviceInfo.groupId);
        });

    }

    function handleError(err){
        console.log(err.name + " : " + err.message);
    }

    start();

</script>